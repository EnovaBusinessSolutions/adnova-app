<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Onboarding 2 - Adray</title>

  <link rel="stylesheet" href="/onboarding.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" />

  <!-- ===================== INTERCOM (E2E) ===================== -->
  <!-- ✅ App ID fijo (puedes cambiarlo por placeholder si lo inyectas desde backend) -->
  <meta name="intercom-app-id" content="sqexnuzh" />

  <script>
    (function () {
      var APP_ID = (document.querySelector('meta[name="intercom-app-id"]') || {}).content;

      if (!APP_ID) {
        console.warn('[Intercom] Missing intercom app id meta tag');
        return;
      }

      // Base settings (visitor mode). Si luego en dashboard haces "secure mode" se hace update/boot con user_hash.
      window.intercomSettings = window.intercomSettings || {};
      window.intercomSettings.app_id = APP_ID;

      (function () {
        var w = window;
        var ic = w.Intercom;
        if (typeof ic === "function") {
          ic("reattach_activator");
          ic("update", w.intercomSettings);
        } else {
          var d = document;
          var i = function () { i.c(arguments); };
          i.q = [];
          i.c = function (args) { i.q.push(args); };
          w.Intercom = i;

          var l = function () {
            var s = d.createElement("script");
            s.type = "text/javascript";
            s.async = true;
            s.src = "https://widget.intercom.io/widget/" + APP_ID;
            var x = d.getElementsByTagName("script")[0];
            x.parentNode.insertBefore(s, x);
          };

          if (document.readyState === "complete") l();
          else if (w.attachEvent) w.attachEvent("onload", l);
          else w.addEventListener("load", l, false);
        }
      })();

      // ✅ Marcar vista del onboarding (no rompe nada si Intercom aún no terminó de cargar)
      window.addEventListener('load', function () {
        try {
          if (typeof window.Intercom === 'function') {
            window.Intercom('update', {
              app_id: APP_ID,
              custom_launcher_selector: null,
              page: 'onboarding_step_2',
            });

            // Evento opcional (si no lo quieres, bórralo)
            try { window.Intercom('trackEvent', 'onboarding_step_view', { step: 2 }); } catch (_) {}
          }
        } catch (_) {}
      });
    })();
  </script>
  <!-- =========================================================== -->

  <!-- ✅ Overrides SOLO para esta vista (mobile impecable, sin tocar tu lógica) -->
  <style>
    /* Igualar tamaño del botón Atrás con el CTA */
    #back-btn-2.btn-secondary{
      padding: 0.75rem 2.1rem;
      font-size: 1.07rem;
      border-radius: 7px;
      min-height: 44px;
      line-height: 1;
    }

    /* ---------------- Mobile progress (Paso 2/4) ---------------- */
    #adnova-mobile-progress{display:none;margin:2px 0 14px 0}
    #adnova-mobile-progress .amp-row{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;margin-bottom:10px}
    #adnova-mobile-progress .amp-step{display:block;font-weight:800;color:#e9ddff;font-size:1.05rem;letter-spacing:.2px}
    #adnova-mobile-progress .amp-sub{display:block;color:#b6a7e8;font-size:.85rem;margin-top:2px}
    #adnova-mobile-progress .amp-mini{color:#b6a7e8;font-size:.82rem;opacity:.9;text-align:right;display:block;max-width:190px}
    #adnova-mobile-progress .amp-bar{height:8px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
    #adnova-mobile-progress .amp-fill{height:100%;background:linear-gradient(90deg,#A96BFF 0%,#9333ea 100%);border-radius:999px;transition:width .25s ease}

    /* ---------------- Mobile: layout impecable ---------------- */
    @media (max-width: 600px){
      /* Container full-screen real en iPhone */
      .onboarding-container{
        height: 100dvh;
        max-height: none;
        margin: 0;
        border-radius: 0;
      }

      /* Sidebar compacto (no se come el contenido) */
      .sidebar{
        padding: 14px 16px;
      }
      .sidebar .steps{
        display: none; /* usamos el progreso móvil arriba */
      }
      .logo{
        margin-bottom: 0 !important;
      }

      /* Header progreso visible */
      #adnova-mobile-progress{display:block}

      /* Main content más cómodo */
      .main-content{
        padding: 16px !important;
      }

      /* Permisos más compactos */
      .permissions-list{
        gap: 12px;
      }
      .permission-item{
        padding: 14px !important;
      }
      .permission-icon{
        width: 28px;
        height: 28px;
        font-size: .9rem;
      }
      .permission-text h3{
        font-size: .98rem;
      }
      .permission-text p{
        font-size: .9rem;
      }

      /* Bottom actions sticky (CTA siempre visible) */
      .bottom-actions{
        position: sticky;
        bottom: 0;
        padding: 12px 0 calc(12px + env(safe-area-inset-bottom));
        margin-top: 18px;
        background: linear-gradient(
          180deg,
          rgba(10,10,18,0) 0%,
          rgba(10,10,18,.78) 30%,
          rgba(10,10,18,.92) 100%
        );
        backdrop-filter: blur(8px);
        z-index: 5;
      }

      /* Cuando se apilan, que se vea pro */
      #back-btn-2.btn-secondary,
      #continue-btn-2.btn-continue{
        width: 100%;
      }
    }
  </style>

  <!-- ===================== PIXELES / TRACKING ===================== -->

  <!-- Google tag (gtag.js) - GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-7FR1P31TK3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-7FR1P31TK3');
  </script>

  <!-- Meta Pixel Code -->
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '822068647105181');
    fbq('track', 'PageView');
  </script>
  <!-- End Meta Pixel Code -->

  <!-- Microsoft Clarity -->
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)}
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "ugeg5ymvp5");
  </script>

  <!-- =============================================================== -->
</head>

<body data-page="onboarding" data-user-id="USER_ID_REAL">
  <!-- Meta Pixel (noscript) -->
  <noscript>
    <img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id=822068647105181&ev=PageView&noscript=1" />
  </noscript>

  <span id="shopifyConnectedFlag"  style="display:none">SHOPIFY_CONNECTED_FLAG</span>
  <span id="googleConnectedFlag"   style="display:none">GOOGLE_CONNECTED_FLAG</span>

  <div class="onboarding-container" id="onboarding">

    <aside class="sidebar">
      <div class="logo">
        <h1>Adray<span class="emoji"></span></h1>
      </div>

      <div class="steps">
        <div class="step completed" data-step="1">
          <div class="step-indicator"><span class="step-number">1</span></div>
          <div class="step-text">
            <h3>Conecta tus cuentas</h3>
            <p>Agrega tu tienda y cuentas de marketing</p>
          </div>
        </div>

        <div class="step active" data-step="2">
          <div class="step-indicator"><span class="step-number">2</span></div>
          <div class="step-text">
            <h3>Revisar permisos</h3>
            <p>Verifica y acepta los permisos requeridos</p>
          </div>
        </div>

        <div class="step" data-step="3">
          <div class="step-indicator"><span class="step-number">3</span></div>
          <div class="step-text">
            <h3>Análisis</h3>
            <p>Analizaremos los datos de tu tienda</p>
          </div>
        </div>

        <div class="step" data-step="4">
          <div class="step-indicator"><span class="step-number">4</span></div>
          <div class="step-text">
            <h3>Dashboard</h3>
            <p>Consulta los resultados de optimización</p>
          </div>
        </div>
      </div>
    </aside>

    <main class="main-content">

      <div id="adnova-mobile-progress" aria-hidden="false">
        <div class="amp-row">
          <div class="amp-left">
            <span class="amp-step">Paso 2 de 4</span>
            <span class="amp-sub">Revisar permisos</span>
          </div>
          <div class="amp-right">
            <span class="amp-mini">Autoriza los accesos para continuar</span>
          </div>
        </div>
        <div class="amp-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="50">
          <div class="amp-fill" style="width:50%"></div>
        </div>
      </div>

      <section id="step1-content" class="content-panel hidden" aria-hidden="true" data-step-content="1">
        <h2>Conecta tus cuentas</h2>
        <p class="panel-description">Conecta al menos una plataforma (Shopify, Google o Meta) para continuar.</p>

        <div class="bottom-actions">
          <button class="btn-secondary" id="go-to-step2">Ir al paso 2</button>
        </div>
      </section>

      <section id="step2-content" class="content-panel" aria-hidden="false" data-step-content="2">
        <h2>Revisar permisos</h2>
        <p class="panel-description">
          Adray necesita acceso a los datos de tus cuentas de marketing y tu tienda para optimizar campañas y generar auditorías inteligentes.
        </p>

        <div class="permissions-list">
          <div class="permission-item">
            <div class="permission-icon">✓</div>
            <div class="permission-text">
              <h3>Acceso a campañas y anuncios</h3>
              <p>Permite leer el rendimiento de tus campañas en Google Ads, Meta Ads y otras plataformas.</p>
            </div>
          </div>

          <div class="permission-item">
            <div class="permission-icon">✓</div>
            <div class="permission-text">
              <h3>Acceso a cuentas y configuración</h3>
              <p>Permite identificar tus cuentas conectadas y validar la configuración de seguimiento.</p>
            </div>
          </div>

          <div class="permission-item">
            <div class="permission-icon">✓</div>
            <div class="permission-text">
              <h3>Acceso a métricas y analíticas</h3>
              <p>Permite analizar datos de conversión, audiencias y rendimiento.</p>
            </div>
          </div>
        </div>

        <div class="bottom-actions">
          <button class="btn-secondary" id="back-btn-2">Atrás</button>
          <button class="btn-continue" id="continue-btn-2">Autorizar accesos</button>
        </div>
      </section>

    </main>
  </div>

  <!-- ✅ Opcional: al navegar entre steps, evita duplicados del widget -->
  <script>
    window.addEventListener('beforeunload', function () {
      try { if (typeof window.Intercom === 'function') window.Intercom('shutdown'); } catch (_) {}
    });
  </script>

  <script type="module" src="/js/onboarding2.js"></script>
</body>
</html>
