<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pago confirmado · Adnova AI</title>
  <!-- === Design tokens (idénticos a plan-src/src/index.css) === -->
  <style>
    :root{
      --background: 240 10% 3.9%;
      --foreground: 0 0% 98%;

      --card: 240 10% 7%;
      --card-foreground: 0 0% 98%;

      --accent: 262 83% 58%;
      --accent-foreground: 0 0% 98%;

      --muted: 240 10% 12%;
      --muted-foreground: 240 5% 64.9%;

      --border: 240 3.7% 15.9%;
      --ring: 262 83% 58%;
    }

    /* ===== Base ===== */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: hsl(var(--background));
      color: hsl(var(--foreground));
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      letter-spacing:.2px;
    }

    /* Fondo con brillo y partículas sutiles */
    .scene{
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 600px at 30% -10%, hsl(var(--accent) / .12) 0%, transparent 60%),
        radial-gradient(1000px 500px at 80% 110%, hsl(var(--accent) / .10) 0%, transparent 60%),
        hsl(var(--background));
      pointer-events:none;
      filter: saturate(.9);
    }

    /* ===== Card ===== */
    .wrap{
      min-height:100%;
      display:grid;
      place-items:center;
      padding:28px 16px;
    }
    .card{
      width:min(820px, 92vw);
      background:hsl(var(--card));
      color:hsl(var(--card-foreground));
      border:1px solid hsl(var(--border));
      border-radius:20px;
      padding:28px;
      box-shadow:
        0 10px 40px hsl(var(--accent)/.18),
        0 0 0 1px hsl(var(--accent)/.08) inset;
    }
    .card h1{
      margin:0 0 8px 0;
      font-size:clamp(22px, 2.6vw, 30px);
      font-weight:800;
      line-height:1.15;
      color:hsl(var(--accent));
      letter-spacing:-.3px;
    }
    .card p.lead{
      margin:0 0 18px 0;
      color:hsl(var(--muted-foreground));
      font-size:15px;
    }

    /* ===== Alert / toasts ===== */
    .alert{
      display:inline-flex; align-items:center; gap:.6rem;
      padding:10px 14px;
      border-radius:999px;
      font-size:14px; font-weight:700;
      border:1px solid transparent;
      margin:.4rem 0 1.2rem 0;
    }
    .alert--info{
      color:#FFEAD1;
      background:linear-gradient(0deg, #2A1C12, #2A1C12);
      border-color:#53321C;
    }
    .alert--ok{
      color:#E3FFE9;
      background:#12281E; border-color:#1F5A3C;
    }
    .alert--warn{
      color:#FFF6E5;
      background:#2A2412; border-color:#5E4F1F;
    }

    /* ===== Listado de estado ===== */
    .list{
      display:grid; gap:12px; margin:18px 0 22px 0;
    }
    .row{
      display:grid;
      grid-template-columns: 200px 1fr;
      gap:14px;
      align-items:center;
      background:hsl(var(--muted));
      border:1px solid hsl(var(--border));
      border-radius:12px;
      padding:14px 16px;
    }
    .row .k{
      color:hsl(var(--muted-foreground));
      font-weight:600;
      font-size:13px;
    }
    .row .v{
      font-weight:700;
      letter-spacing:.2px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:.4rem;
      font-size:12px; font-weight:800;
      padding:.35rem .6rem;
      border-radius:999px;
      border:1px solid hsl(var(--border));
      background:hsl(var(--background));
    }
    .badge--accent{
      color:hsl(var(--accent-foreground));
      background:hsl(var(--accent)/.18);
      border-color:hsl(var(--accent)/.35);
    }

    /* ===== Buttons ===== */
    .btns{ display:flex; gap:10px; flex-wrap:wrap; }
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:12px 18px; border-radius:10px;
      font-weight:800; letter-spacing:.2px; font-size:14px;
      transition:transform .08s ease, box-shadow .2s ease, opacity .2s ease;
    }
    .btn:active{ transform:translateY(1px) }
    .btn--primary{
      color:hsl(var(--accent-foreground));
      background:hsl(var(--accent));
      box-shadow:0 8px 20px hsl(var(--accent)/.35);
    }
    .btn--primary:hover{ box-shadow:0 10px 28px hsl(var(--accent)/.5) }
    .btn--ghost{
      color:hsl(var(--foreground));
      background:transparent;
      border:1px solid hsl(var(--border));
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed }

    .help{
      margin-top:10px;
      color:hsl(var(--muted-foreground));
      font-size:13px;
    }
    .help a{ color:hsl(var(--accent)); font-weight:700; text-decoration:none }
    .help a:hover{ text-decoration:underline }
  </style>
</head>
<body>
  <div class="scene" aria-hidden="true"></div>
  <main class="wrap">
    <section class="card" role="status">
      <h1>¡Gracias! Estamos activando tu plan…</h1>
      <p class="lead">No cierres esta pestaña. Puede tardar unos segundos mientras confirmamos con Stripe.</p>

      <div id="toast" class="alert alert--info">Consultando estado…</div>

      <div class="list">
        <div class="row">
          <div class="k">Sesión</div>
          <div class="v"><span id="v-auth" class="badge">—</span></div>
        </div>
        <div class="row">
          <div class="k">Mi plan detectado</div>
          <div class="v"><span id="v-plan" class="badge badge--accent">—</span></div>
        </div>
        <div class="row">
          <div class="k">Suscripción</div>
          <div class="v"><span id="v-sub" class="badge">—</span></div>
        </div>
      </div>

      <div class="btns">
        <a href="/plans" class="btn btn--ghost">Volver a planes</a>
        <a id="goDash" href="/dashboard" class="btn btn--primary" disabled>Ir al dashboard</a>
      </div>

      <p class="help" id="helpLine" hidden>
        ¿No ves tu plan actualizado? 
        <a href="/logout">Cerrar sesión y volver a entrar</a>.
      </p>
    </section>
  </main>

  <script>
    // Utilidades pequeñas
    const $ = (id) => document.getElementById(id);
    const toast = (type, text) => {
      const el = $('toast');
      el.textContent = text;
      el.className = 'alert ' + (type === 'ok' ? 'alert--ok' : type === 'warn' ? 'alert--warn' : 'alert--info');
    };

    const authEl = $('v-auth');
    const planEl = $('v-plan');
    const subEl  = $('v-sub');
    const goDash = $('goDash');
    const help   = $('helpLine');

    // Estado de polling
    let tries = 0;
    const maxTries = 35; // ~105s

    async function loadMe() {
      try {
        const r = await fetch('/api/me', { credentials: 'include' });
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();

        if (!data.authenticated) {
          authEl.textContent = 'Sin sesión';
          toast('warn', 'Inicia sesión para terminar de activar tu plan.');
          help.hidden = false;
          return false;
        }

        // Pinta estado:
        authEl.textContent = data.email || 'Autenticado';
        planEl.textContent = data.plan || '—';

        const sub = data.subscription || {};
        subEl.textContent = (sub.status || '—');

        // ¿listo?
        const active = (sub.status === 'active' || ['emprendedor','crecimiento','pro'].includes((data.plan||'').toLowerCase()));
        if (active) {
          toast('ok', '¡Listo! Tu plan está activo.');
          goDash.removeAttribute('disabled');
          help.hidden = true;
          return true;
        }

        // Si aún no, seguimos intentando
        toast('info', 'Confirmando con Stripe…');
        return false;
      } catch (e) {
        toast('warn', 'Error consultando el estado. Reintentando…');
        return false;
      }
    }

    async function poll() {
      const done = await loadMe();
      if (done) return;
      tries++;
      if (tries < maxTries) {
        setTimeout(poll, 3000);
      } else {
        toast('warn', 'Tarda más de lo normal. Puedes ir a “Volver a planes” o entrar al dashboard.');
        help.hidden = false;
        goDash.removeAttribute('disabled');
      }
    }

    // Arranca
    poll();
  </script>
</body>
</html>
