<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Adnova AI Connector</title>
  <!-- Shopify App Bridge: DEBE ser el PRIMER script, sin type/module/async/defer -->
  <meta name="shopify-api-key" content="168d118e58d5e1bd2bd787957e136f2b">
  <script src="https://cdn.shopify.com/shopifycloud/app-bridge.js"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap");
    :root { --bg: #12002e; --bg2: #220045; --accent: #9a5bff; --accentH: #8249e3; --txt: #fff; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh; display: grid; place-content: center;
      font: 400 16px/1.55 Inter, system-ui, sans-serif;
      background: radial-gradient(circle at 30% 30%, var(--bg2), var(--bg));
      color: var(--txt); text-align: center; padding: 0 1rem;
    }
    h1 { font-size: clamp(2.4rem, 5vw, 3.3rem); font-weight: 600; margin: .5em 0; }
    p { max-width: 560px; margin: 0 auto 2rem; }
    code { background: #1e1e29; border-radius: 4px; padding: 2px 6px; }
    .btn { display: inline-block; padding: 15px 42px; border-radius: 8px;
      background: var(--accent); color: #fff; font-weight: 600;
      text-decoration: none; transition: .2s background; }
    .btn:hover { background: var(--accentH); }
    .btn:disabled { background: #555; cursor: not-allowed; }
  </style>
</head>
<body>
  <main>
    <h1>✅ ¡Tienda conectada!</h1>
    <p>
      Ahora regresa a <b>Adnova AI</b>, inicia sesión o refresca tu pestaña y escribe el
      dominio <code id="shopDom">(dominio)</code> cuando se te pida.
    </p>
    <button id="goToAdnova" class="btn">Ir a Adnova AI</button>
  </main>
  <script>
    // --- Parámetros de la URL ---
    const apiKey = document.querySelector('meta[name="shopify-api-key"]').content;
    const params = new URLSearchParams(window.location.search);
    const host = params.get('host');
    const shop = params.get('shop');

    // Mostrar dominio en la UI
    if (shop) document.getElementById("shopDom").textContent = shop;

    // Verificación rápida
    if (!apiKey || !host) {
      document.body.innerHTML = "<h2>Error: Falta apiKey o host en la URL.<br>Debes abrir esta app desde el panel de Shopify.</h2>";
      throw new Error("Falta apiKey o host en la URL");
    }

    // --- Inicializa App Bridge y obtiene session token ---
    let sessionToken = null;
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const AppBridge = window['app-bridge'];
        if (!AppBridge) {
          throw new Error("App Bridge NO está disponible en window['app-bridge']");
        }
        const createApp = AppBridge.default;
        const app = createApp({ apiKey, host });
        sessionToken = await AppBridge.getSessionToken(app);
        if (!sessionToken) throw new Error("No se pudo obtener sessionToken");
        sessionStorage.setItem("sessionToken", sessionToken);

        // Puedes habilitar el botón cuando ya tienes el token
        document.getElementById("goToAdnova").disabled = false;
      } catch (err) {
        document.getElementById("goToAdnova").disabled = true;
        document.body.innerHTML += "<p style='color:#ff6666'><b>Error App Bridge:</b> " + err.message + "</p>";
      }
    });

    // --- Redirigir al SAAS con el token y dominio ---
    document.getElementById("goToAdnova").addEventListener("click", function() {
      // Asegúrate de que el sessionToken fue obtenido
      if (!sessionToken) {
        alert("El token de sesión no está listo. Espera unos segundos e intenta de nuevo.");
        return;
      }
      // Cambia la URL a la de tu app SAAS, pasando shop y (si quieres) el token
      // Lo usual es pasar solo ?shop=... y que el SAAS lo pida vía API usando sessionStorage
      window.open(`https://adnova-app.onrender.com/onboarding?shop=${encodeURIComponent(shop)}`, "_blank");
    });
  </script>
</body>
</html>
