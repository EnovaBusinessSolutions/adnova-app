<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Adnova AI Connector</title>

  <!-- ✅ App Bridge oficial SIN versión -->
  <script
    src="https://cdn.shopify.com/shopifycloud/app-bridge.js"
    data-api-key="168d118e58d5e1bd2bd787957e136f2b">
  </script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap");
    :root {
      --bg: #12002e;
      --bg2: #220045;
      --accent: #9a5bff;
      --accentH: #8249e3;
      --txt: #fff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      display: grid;
      place-content: center;
      font: 400 16px/1.55 Inter, system-ui, sans-serif;
      background: radial-gradient(circle at 30% 30%, var(--bg2), var(--bg));
      color: var(--txt); text-align: center; padding: 0 1rem;
    }
    h1 { font-size: clamp(2.4rem, 5vw, 3.3rem); font-weight: 600; margin: .5em 0; }
    p { max-width: 560px; margin: 0 auto 2rem; }
    code {
      background: #1e1e29;
      border-radius: 4px;
      padding: 2px 6px;
    }
    .btn {
      display: inline-block;
      padding: 15px 42px;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      transition: .2s background;
    }
    .btn:hover { background: var(--accentH); }
  </style>
</head>

<body>
  <main>
    <h1>✅ ¡Tienda conectada!</h1>
    <p>
      Ahora regresa a <b>Adnova AI</b>, inicia sesión o refresca tu pestaña y escribe el
      dominio <code id="shopDom">(dominio)</code> cuando se te pida.
    </p>
    <a id="backToAdnova" class="btn" target="_top" href="#">Ir a Adnova AI</a>
  </main>

  <!-- ✅ Módulo JS separado para usar Session Token y llamar al backend -->
  <script type="module">
    const qs   = new URLSearchParams(location.search);
    const shop = qs.get('shop') || '';
    const host = qs.get('host') || '';
    const apiKey = document.querySelector("script[data-api-key]").dataset.apiKey;

    // Pinta dominio
    document.getElementById('shopDom').textContent = shop;

    // Link de regreso al SAAS
const back = new URL('https://adnova-app.onrender.com/onboarding');
back.searchParams.set('shop', shop);
if (host) back.searchParams.set('host', host);
document.getElementById('backToAdnova').href = back.toString();

// Al hacer clic, guardamos dominio y redirigimos
document.getElementById('backToAdnova').addEventListener('click', (e) => {
  e.preventDefault();
  if (shop) sessionStorage.setItem('shopDomain', shop);
  sessionStorage.setItem('shopifyConnected', 'true');
  window.top.location.href = back.toString();
});

    // Espera a que AppBridge esté cargado
    function waitForAppBridge(timeout = 3000) {
      return new Promise((resolve, reject) => {
        const start = Date.now();
        (function check() {
          const AB = window['app-bridge'] || window.AppBridge;
          if (AB?.default && AB.utilities) return resolve(AB);
          if (Date.now() - start > timeout) return reject(new Error("App Bridge not loaded"));
          requestAnimationFrame(check);
        })();
      });
    }

    const AppBridge = await waitForAppBridge();
    const createApp = AppBridge.default;
    const { getSessionToken } = AppBridge.utilities;

    const app = createApp({ apiKey, host });

    // ✅ Esta llamada con JWT es la que el checker necesita ver
    try {
      const token = await getSessionToken(app);
      const res = await fetch("/api/secure/ping", {
        headers: { Authorization: `Bearer ${token}` }
      });
      const json = await res.json();
      console.log("✅ PING ok:", json);
    } catch (err) {
      console.error("❌ PING error:", err);
    }
  </script>
</body>
</html>
