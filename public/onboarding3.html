<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Onboarding 3 - Adray</title>

  <!-- CSS principal -->
  <link rel="stylesheet" href="/onboarding.css" />

  <!-- Fuente -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" />

  <!-- Evita cachés agresivos durante el flujo -->
  <meta http-equiv="Cache-Control" content="no-store" />

  <!-- ✅ Intercom App ID (CSP-friendly) -->
  <meta name="intercom-app-id" content="sqexnuzh" />

  <!-- Pequeños ajustes SOLO para esta vista (no rompen PC) -->
  <style>
    /* Evita que el botón quede “muy abajo” en móviles pequeños */
    @media (max-width: 600px){
      .bottom-actions {
        margin-top: 1.25rem;
      }
    }

    /* Mejor tap targets en móvil */
    #btn-continue {
      min-height: 44px;
    }

    /* Badge base (si JS lo usa) */
    .badge[data-badge]{
      margin-left: 10px;
      font-size: .78rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(169,107,255,.22);
      color: rgba(244,242,255,.85);
      background: rgba(169,107,255,.08);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      line-height: 1;
      vertical-align: middle;
    }
  </style>

  <!-- ===================== PIXELES / TRACKING ===================== -->

  <!-- Google tag (gtag.js) - GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-7FR1P31TK3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-7FR1P31TK3');
  </script>

  <!-- Meta Pixel Code -->
  <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '822068647105181');
    fbq('track', 'PageView');
  </script>

  <!-- Microsoft Clarity -->
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)}
      t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i
      y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y)
    })(window, document, "clarity", "script", "ugeg5ymvp5");
  </script>

  <!-- ===================== INTERCOM (VISITORS + USER MODE) ===================== -->
  <script>
    (function () {
      var w = window;
      var APP_ID = (document.querySelector('meta[name="intercom-app-id"]') || {}).content || "sqexnuzh";

      // Si ya tienes user_id real, reemplaza USER_ID_REAL en backend al renderizar HTML
      var userId = document.body && document.body.getAttribute("data-user-id");
      if (!userId || userId === "USER_ID_REAL") userId = null;

      w.intercomSettings = {
        app_id: APP_ID,
        // Metadata útil para automatizaciones
        page: "onboarding_step_3",
        step: 3,
        custom_attributes: {
          onboarding_step: 3,
          onboarding_page: "onboarding_step_3"
        },
        ...(userId ? { user_id: String(userId) } : {})
      };

      var ic = w.Intercom;
      if (typeof ic === "function") {
        ic("reattach_activator");
        ic("update", w.intercomSettings);
      } else {
        var d = document;
        var i = function () { i.c(arguments); };
        i.q = [];
        i.c = function (args) { i.q.push(args); };
        w.Intercom = i;

        var l = function () {
          var s = d.createElement("script");
          s.type = "text/javascript";
          s.async = true;
          s.src = "https://widget.intercom.io/widget/" + APP_ID;
          var x = d.getElementsByTagName("script")[0];
          x.parentNode.insertBefore(s, x);
        };

        if (d.readyState === "complete") {
          l();
        } else if (w.attachEvent) {
          w.attachEvent("onload", l);
        } else {
          w.addEventListener("load", l, false);
        }
      }
    })();
  </script>
  <!-- =============================================================== -->
</head>

<body data-page="onboarding3" data-user-id="USER_ID_REAL">
  <!-- Meta Pixel (noscript) -->
  <noscript>
    <img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id=822068647105181&ev=PageView&noscript=1" />
  </noscript>

  <div class="onboarding-container">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Progreso de onboarding">
      <div class="logo">
        <h1>Adray<span class="emoji"></span></h1>
      </div>

      <nav class="steps" aria-label="Pasos">
        <div class="step completed" data-step="1" aria-current="false">
          <div class="step-indicator"><span class="step-number">1</span></div>
          <div class="step-text">
            <h3>Conecta tus cuentas</h3>
            <p>Agrega tu tienda y cuentas de marketing</p>
          </div>
        </div>

        <div class="step completed" data-step="2" aria-current="false">
          <div class="step-indicator"><span class="step-number">2</span></div>
          <div class="step-text">
            <h3>Revisar permisos</h3>
            <p>Verifica y acepta los permisos requeridos</p>
          </div>
        </div>

        <div class="step active" data-step="3" aria-current="step">
          <div class="step-indicator"><span class="step-number">3</span></div>
          <div class="step-text">
            <h3>Análisis</h3>
            <p>Analizaremos los datos de tu tienda</p>
          </div>
        </div>

        <div class="step" data-step="4" aria-current="false">
          <div class="step-indicator"><span class="step-number">4</span></div>
          <div class="step-text">
            <h3>Dashboard</h3>
            <p>Consulta los resultados de optimización</p>
          </div>
        </div>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main-content">
      <section class="content-panel" id="step3-content" aria-labelledby="title-analisis">
        <h2 id="title-analisis">Análisis</h2>

        <p class="panel-description">
          Estamos analizando los datos de tus cuentas para ofrecerte recomendaciones personalizadas de marketing.
        </p>

        <div class="analysis-hint" role="status" aria-live="polite">
          <span class="analysis-hint-icon">!</span>
          <span class="analysis-hint-text">Este proceso puede tardar unos minutos.</span>
        </div>

        <div class="analysis-progress" aria-label="Progreso de análisis">
          <div class="progress-container">
            <div
              class="progress-bar"
              role="progressbar"
              aria-valuemin="0"
              aria-valuemax="100"
              aria-valuenow="0"
              aria-label="Barra de progreso del análisis"
            >
              <div id="progress-bar" class="progress-indicator" style="width: 0%"></div>
            </div>
            <p class="progress-text" id="progress-text">Preparando análisis…</p>
          </div>

          <ul id="analysis-list" class="analysis-steps" aria-label="Etapas del análisis">
            <li id="step-googleads" class="analysis-step">
              <div class="analysis-step-icon" aria-hidden="true">○</div>
              <div class="analysis-step-text">
                Google Ads
                <span class="badge" data-badge></span>
              </div>
            </li>

            <li id="step-meta" class="analysis-step">
              <div class="analysis-step-icon" aria-hidden="true">○</div>
              <div class="analysis-step-text">
                Meta Ads
                <span class="badge" data-badge></span>
              </div>
            </li>

            <li id="step-shopify" class="analysis-step">
              <div class="analysis-step-icon" aria-hidden="true">○</div>
              <div class="analysis-step-text">
                Shopify
                <span class="badge" data-badge></span>
              </div>
            </li>

            <li id="step-ga4" class="analysis-step">
              <div class="analysis-step-icon" aria-hidden="true">○</div>
              <div class="analysis-step-text">
                Google Analytics
                <span class="badge" data-badge></span>
              </div>
            </li>
          </ul>
        </div>

        <div class="bottom-actions">
          <button class="btn-continue" id="btn-continue" disabled>Continuar</button>
        </div>
      </section>
    </main>
  </div>

  <!-- JS -->
  <script src="/js/onboarding3.js" defer></script>

  <!-- ✅ Anti-duplicado: si el usuario navega con links, cerramos Intercom antes -->
  <script>
    (function () {
      function safeShutdown() {
        try {
          if (typeof window.Intercom === "function") window.Intercom("shutdown");
        } catch {}
      }

      // cuando el navegador vaya a salir de la página
      window.addEventListener("beforeunload", safeShutdown);

      // si hay links internos (por si en el futuro agregas)
      document.addEventListener("click", function (e) {
        var a = e.target && e.target.closest ? e.target.closest("a") : null;
        if (!a) return;
        // si navega fuera o a otra ruta
        safeShutdown();
      }, true);
    })();
  </script>

  <noscript>Por favor activa JavaScript para continuar.</noscript>
</body>
</html>
